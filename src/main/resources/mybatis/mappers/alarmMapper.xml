<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinhan.alarm">
	<!-- ÏïåÎ¶º Ï†ÑÏ≤¥ Ï°∞Ìöå  -->
	<select id="alarmList" parameterType="string" resultType="alarmChatDTO">
		<![CDATA[
			SELECT *
			FROM (SELECT NVL(S.ARTICLE_TITLE, 'From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender,
			A.AL_CONTENT alContent,
			TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI') alDate,
			NF.CATE_NUM cateNum,
			A.AL_REQ_SEQ reqSeq,
			A.AL_NUM alNum,
			A.AL_CHECK alCheck
			FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
			JOIN DEAL_HISTORY DH ON (A.ID = DH.BUYER_ID)
			JOIN DELIVERY D ON (DH.S_SEQ = D.S_SEQ)
			JOIN SELL_PRODUCT S ON (S.PRODUCT_SEQ = DH.SELL_SEQ)
			WHERE A.ID = 'b'
			AND A.CATE_NUM = 5 -- Î∞∞ÏÜ°
			AND A.AL_REQ_SEQ = D.D_SEQ
			AND D.D_STATUS = 'Î∞úÏÜ°ÏôÑÎ£å'
			UNION ALL
			SELECT NVL(NULL, 'From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender,
			A.AL_CONTENT alContent,
			TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI') alDate,
			NF.CATE_NUM cateNum,
			A.AL_REQ_SEQ reqSeq,
			A.AL_NUM alNum,
			A.AL_CHECK alCheck
			FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
			JOIN QNA_BOARD Q ON (A.ID = Q.ID)
			WHERE A.ID = 'b'
			AND A.CATE_NUM = 4 -- Î¨∏Ïùò
			AND A.AL_REQ_SEQ = Q.SEQ_QNA_BNO
			UNION ALL
			SELECT NVL(AP.AUCTION_TITLE, 'From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender,
			A.AL_CONTENT alContent,
			TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI') alDate,
			NF.CATE_NUM cateNum,
			A.AL_REQ_SEQ reqSeq,
			A.AL_NUM alNum,
			A.AL_CHECK alCheck
			FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
			JOIN AUC_PRODUCT AP ON (A.AL_REQ_SEQ = AP.PRODUCT_SEQ)
			WHERE A.ID = 'b'
			AND A.CATE_NUM = 3 -- Í≤ΩÎß§
			AND A.AL_REQ_SEQ = AP.PRODUCT_SEQ
			UNION ALL
			SELECT NVL(NULL, 'From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender,
			A.AL_CONTENT alContent,
			TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI') alDate,
			NF.CATE_NUM cateNum,
			A.AL_REQ_SEQ reqSeq,
			A.AL_NUM alNum,
			A.AL_CHECK alCheck
			FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
			JOIN DEAL_HISTORY DH ON (A.ID = DH.BUYER_ID)
			WHERE A.ID = 'b'
			AND A.CATE_NUM = 2 -- ÌåêÎß§
			AND A.AL_REQ_SEQ = DH.S_SEQ
			UNION ALL
			SELECT NVL(CM.SENDER, 'From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender,
			A.AL_CONTENT alContent,
			TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI') alDate,
			NF.CATE_NUM cateNum,
			A.AL_REQ_SEQ reqSeq,
			A.AL_NUM alNum,
			A.AL_CHECK alCheck
			FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
			JOIN CHAT_MESSAGE CM ON (A.ID = CM.RECEIVER)
			WHERE A.ID = 'b'
			AND A.CATE_NUM = 1 -- Ï±ÑÌåÖ
			AND A.AL_REQ_SEQ = CM.MSG_ID)
			WHERE SYSDATE < ADD_MONTHS(TO_DATE(alDate, 'YYYY/MM/DD / HH24:MI'), 1)
			ORDER BY alDate DESC NULLS LAST, alCheck NULLS LAST
			]]>
	</select>
	
	<!-- ÎØ∏ÌôïÏù∏ ÏïåÎ¶º Ï°∞Ìöå -->
	<select id="alarmUnck" parameterType="string" resultType="alarmChatDTO">
		SELECT * 
		FROM(SELECT NVL(NULL, 'üì¢ From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender, 
							  MAX(A.AL_CONTENT) alContent, 
							  MAX(TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI')) alDate, 
							  MAX(NF.CATE_NUM) cateNum, 
							  MAX(A.AL_REQ_SEQ) reqSeq, 
							  MAX(A.AL_NUM) alNum, 
							  MAX(A.AL_CHECK) alCheck 
				  FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM) 
										 JOIN QNA_BOARD Q ON (A.ID = Q.ID) 
				  WHERE A.CATE_NUM = 4 -- Î¨∏Ïùò 
							  AND AL_CHECK = 'N' 
							  AND A.ID = #{userId} 
				  UNION ALL 
				  SELECT NVL(NULL, 'üì¢ From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender, 
							  MAX(A.AL_CONTENT) alContent, 
							  MAX(TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI')) alDate, 
							  MAX(NF.CATE_NUM) cateNum, 
							  MAX(A.AL_REQ_SEQ) reqSeq, 
							  MAX(A.AL_NUM) alNum, 
							  MAX(A.AL_CHECK) alCheck 
				  FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM) 
										 JOIN DEAL_HISTORY D ON (A.ID = D.BUYER_ID) 
				  WHERE A.CATE_NUM = 2 -- ÌåêÎß§ 
							  AND AL_CHECK = 'N' 
							  AND A.ID = #{userId} 
				  UNION ALL 
				  SELECT NVL(MAX(S.ARTICLE_TITLE), 'üì¢ From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender, 
							  MAX(A.AL_CONTENT) alContent, 
							  MAX(TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI')) alDate, 
							  MAX(NF.CATE_NUM) cateNum, 
							  MAX(A.AL_REQ_SEQ) reqSeq, 
							  MAX(A.AL_NUM) alNum, 
							  MAX(A.AL_CHECK) alCheck 
				  FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM) 
										 JOIN DEAL_HISTORY DH ON (A.ID = DH.BUYER_ID) 
										 JOIN DELIVERY D ON (DH.S_SEQ = D.S_SEQ) 
										 JOIN SELL_PRODUCT S ON (S.PRODUCT_SEQ = SELL_SEQ) 
				  WHERE A.CATE_NUM = 5 -- Î∞∞ÏÜ° 
							  AND AL_CHECK = 'N' 
							  AND A.ID = #{userId} 
							  AND D.D_STATUS = 'Î∞úÏÜ°ÏôÑÎ£å' 
				  UNION ALL 
				  SELECT NVL(MAX(AP.AUCTION_TITLE), 'üì¢ From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender, 
							  MAX(A.AL_CONTENT) alContent, 
							  MAX(TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI')) alDate, 
							  MAX(NF.CATE_NUM) cateNum, 
							  MAX(A.AL_REQ_SEQ) reqSeq, 
							  MAX(A.AL_NUM) alNum, 
							  MAX(A.AL_CHECK) alCheck 
				  FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM) 
										 JOIN AUC_PRODUCT AP ON (A.AL_REQ_SEQ = AP.PRODUCT_SEQ) 
				  WHERE A.CATE_NUM = 3 -- Í≤ΩÎß§ 
							  AND AL_CHECK = 'N' 
							  AND A.ID = #{userId} 
				  UNION ALL 
				  SELECT NVL(CM.SENDER, 'üì¢ From. Ìù¨Ìù¨ÎÇôÏ∞∞') sender, 
							  MAX(A.AL_CONTENT) alContent, 
							  MAX(TO_CHAR(CM.SEND_TIME, 'YYYY-MM-DD / HH24:MI')) alDate, 
							  MAX(NF.CATE_NUM) cateNum, 
							  MAX(A.AL_REQ_SEQ) reqSeq, 
							  MAX(A.AL_NUM) alNum, 
							  MAX(A.AL_CHECK) alCheck 
				  FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM) 
										 JOIN CHAT_MESSAGE CM ON (A.ID = CM.RECEIVER) 
				  WHERE A.CATE_NUM = 1 -- Ï±ÑÌåÖ 
							  AND AL_CHECK = 'N' 
							  AND CM.READ_CHECK = 'N' 
							  AND A.ID = #{userId} 
				  GROUP BY CM.SENDER) 
				  GROUP BY SENDER, ALCONTENT, ALDATE, CATENUM, REQSEQ, ALNUM, ALCHECK 
				  ORDER BY alDate DESC NULLS LAST, alCheck NULLS LAST
	</select>
</mapper>