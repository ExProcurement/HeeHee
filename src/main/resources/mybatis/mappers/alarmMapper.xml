<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinhan.alarm">
	<!-- 미확인 알림 전체 조회 -->
	<select id="alarmList" resultType="com.shinhan.heehee.dto.response.AlarmChatDTO">
		SELECT NULL sender,
		MAX(A.AL_CONTENT) alContent,
		MAX(TO_CHAR(A.AL_DATE, 'YYYY-MM-DD / HH24:MI')) alDate,
		MAX(NF.CATE_NUM) cateNum,
		MAX(A.AL_REQ_SEQ) reqSeq
		FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
		JOIN DEAL_HISTORY D ON (A.ID = D.BUYER_ID)
		WHERE A.CATE_NUM = 2
		AND A.ID = 'dhfl123'
		UNION ALL
		SELECT CM.SENDER sender,
		MAX(A.AL_CONTENT) alContent,
		MAX(TO_CHAR(CM.SEND_TIME, 'YYYY-MM-DD / HH24:MI')) alDate,
		MAX(NF.CATE_NUM) cateNum,
		MAX(A.AL_REQ_SEQ) reqSeq
		FROM ALARM A JOIN NF_CATEGORY NF ON (A.CATE_NUM = NF.CATE_NUM)
		JOIN CHAT_MESSAGE CM ON (A.ID = CM.RECEIVER)
		WHERE CM.READ_CHECK = 'N'
		AND A.CATE_NUM = 1
		AND A.ID = 'b'
		GROUP BY CM.SENDER
		ORDER BY alDate
	</select>
</mapper>